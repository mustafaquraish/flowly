# Implementation Plan - Flowly Core

The goal is to build [flowly](file:///Users/mustafa/dev/flowly), a Python library for creating, manipulating, and visualizing flowcharts options, centered around a graph-based Intermediate Representation (IR) called `flowir`.

## User Review Required

> [!NOTE]
> This plan focuses on the core IR and a basic Python builder. Advanced frontends (DSL) and complex backends (Web UI) are future steps.

## Proposed Changes

### 1. [flowly](file:///Users/mustafa/dev/flowly) Package Structure

Create the initial package structure.

#### [NEW] [flowly/__init__.py](file:///Users/mustafa/dev/flowly/flowly/__init__.py)
#### [NEW] [flowly/core/__init__.py](file:///Users/mustafa/dev/flowly/flowly/core/__init__.py)
#### [NEW] [flowly/core/ir.py](file:///Users/mustafa/dev/flowly/flowly/core/ir.py)
- Define [Node](file:///Users/mustafa/dev/flowly/flowly/core/ir.py#4-13) class.
- Define [Edge](file:///Users/mustafa/dev/flowly/flowly/core/ir.py#30-41) class.
- Define [FlowChart](file:///Users/mustafa/dev/flowly/flowly/core/ir.py#42-66) (Graph) class.
- Define specific node types: [StartNode](file:///Users/mustafa/dev/flowly/flowly/core/ir.py#14-17), [EndNode](file:///Users/mustafa/dev/flowly/flowly/core/ir.py#18-21), [ProcessNode](file:///Users/mustafa/dev/flowly/flowly/core/ir.py#22-25), [DecisionNode](file:///Users/mustafa/dev/flowly/flowly/core/ir.py#26-29).
- All entities should support a `metadata` dict for extensibility.

### 2. Interactive Engine

Logic to traverse the graph and maintain state.

#### [NEW] [flowly/engine/__init__.py](file:///Users/mustafa/dev/flowly/flowly/engine/__init__.py)
#### [NEW] [flowly/engine/runner.py](file:///Users/mustafa/dev/flowly/flowly/engine/runner.py)
- [FlowRunner](file:///Users/mustafa/dev/flowly/flowplay/src/main.js#3-268) class.
- Maintains `current_node`.
- Maintains `context` (variables).
- Methods: [step()](file:///Users/mustafa/dev/flowly/flowly/engine/runner.py#27-54), [choose(path_index)](file:///Users/mustafa/dev/flowly/flowly/engine/runner.py#61-70).

### 3. Frontends (Builder API)

A fluent Python API to construct graphs easily.

#### [NEW] [flowly/frontend/__init__.py](file:///Users/mustafa/dev/flowly/flowly/frontend/__init__.py)
#### [NEW] [flowly/frontend/builder.py](file:///Users/mustafa/dev/flowly/flowly/frontend/builder.py)
- [FlowBuilder](file:///Users/mustafa/dev/flowly/flowly/frontend/builder.py#4-41) class.
- Methods: [start()](file:///Users/mustafa/dev/flowly/flowly/engine/runner.py#11-26), [action()](file:///Users/mustafa/dev/flowly/flowly/frontend/builder.py#16-21), [decision()](file:///Users/mustafa/dev/flowly/flowly/frontend/builder.py#22-27), [end()](file:///Users/mustafa/dev/flowly/flowly/frontend/builder.py#28-33).
- Context manager support for cleanly defining blocks.

### 4. Backends (Mermaid Export)

#### [NEW] [flowly/backend/__init__.py](file:///Users/mustafa/dev/flowly/flowly/backend/__init__.py)
#### [NEW] [flowly/backend/graphviz.py](file:///Users/mustafa/dev/flowly/flowly/backend/graphviz.py)
- [GraphvizExporter](file:///Users/mustafa/dev/flowly/flowly/backend/graphviz.py#5-35) class.
- Uses `graphviz` library to render graphs.
- Supports [render(format='png')](file:///Users/mustafa/dev/flowly/flowplay/src/main.js#93-106) and source generation.

#### [NEW] `flowplay/`
- **Standalone Web Application** (Vite + Vanilla JS).
- Consumes `flow.json` generated by `flowly.core.serialization`.
- Features:
    - Clean, separated UI logic.
    - Fetch API to load flow data.
    - Component-based structure (render node, handle options).
    - styling (CSS).
    - **Visual Inspector UI**: Canvas-like view with central node and directional arrows.
    - **Node Cache**: Runtime Key-Value store associated with each node, displayed as floating tables.

### 5. Serialization

#### [NEW] [flowly/core/serialization.py](file:///Users/mustafa/dev/flowly/flowly/core/serialization.py)
- [Serializer](file:///Users/mustafa/dev/flowly/flowly/core/serialization.py#17-83) class.
- [to_json(flowchart)](file:///Users/mustafa/dev/flowly/flowly/core/serialization.py#46-49) / [from_json(str)](file:///Users/mustafa/dev/flowly/flowly/core/serialization.py#79-83)
- `to_yaml(flowchart)` / `from_yaml(str)`
- Support for reconstructing correct Node subclasses.

### 6. Documentation & Testing (QA)

#### [NEW] [docs/index.md](file:///Users/mustafa/dev/flowly/docs/index.md)
- Entry point for documentation.

#### [NEW] [docs/testing_conventions.md](file:///Users/mustafa/dev/flowly/docs/testing_conventions.md)
- Guide on how to write tests, coverage requirements.

#### [NEW] `tests/`
- [tests/test_core_ir.py](file:///Users/mustafa/dev/flowly/tests/test_core_ir.py): Unit tests for Node, Edge, FlowChart.
- [tests/test_engine.py](file:///Users/mustafa/dev/flowly/tests/test_engine.py): Unit tests for FlowRunner, history, decision making.
- [tests/test_frontend.py](file:///Users/mustafa/dev/flowly/tests/test_frontend.py): Unit tests for FlowBuilder (fluent API).
- [tests/test_serialization.py](file:///Users/mustafa/dev/flowly/tests/test_serialization.py): Roundtrip tests for JSON/YAML.

## Verification Plan

### Automated Tests
I will create a comprehensive test suite using `pytest`.

1.  **IR Construction Tests**: Verify nodes and edges are correctly linked.
2.  **Builder API Tests**: Ensure the fluent API produces the expected IR.
3.  **Runner Tests**:
    - Create a flowchart with a decision.
    - Run it, making choices.
    - Verify correct path traversal and state updates.
4.  **Backend Export Tests**:
    - Generate a simple flowchart.
    - Assert the output string matches expected Mermaid syntax.
    - Assert the output string matches expected Graphviz/SVG syntax.
    - Assert the generated HTML contains expected structure and embedded data.
5.  **Serialization Tests**:
    - Build graph -> to_json -> from_json -> assert equal structure.


### Manual Verification
I will create a demo script `examples/demo_walkthrough.py` that:
1.  Builds a flowchart using the Builder API.
2.  Exports it to Mermaid (print to console).
3.  Interactively runs it in the console (text-based adventure style).
